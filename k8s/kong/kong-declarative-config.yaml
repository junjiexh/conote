apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: default
data:
  kong.yml: |
    _format_version: "3.0"

    # Backend Service
    services:
    - name: backend-service
      url: http://backend:8080
      routes:
      # Public routes - no JWT required
      - name: auth-routes
        paths:
        - /api/auth
        strip_path: false
        plugins:
        - name: cors
          config:
            origins:
            - "*"
            methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
            headers:
            - Accept
            - Authorization
            - Content-Type
            - X-User-Id
            - X-User-Email
            exposed_headers:
            - X-Auth-Token
            credentials: true
            max_age: 3600
        - name: request-size-limiting
          config:
            allowed_payload_size: 10

      - name: health-routes
        paths:
        - /actuator/health
        - /actuator/prometheus
        strip_path: false
        plugins:
        - name: cors
          config:
            origins:
            - "*"
            methods:
            - GET
            headers:
            - Accept
            - Content-Type
            credentials: false

      # Protected routes - JWT required
      - name: documents-routes
        paths:
        - /api/documents
        strip_path: false
        plugins:
        - name: jwt
          config:
            uri_param_names:
            - jwt
            header_names:
            - Authorization
            claims_to_verify:
            - exp
            key_claim_name: iss
            secret_is_base64: false
            anonymous: null
            run_on_preflight: true
        - name: request-transformer
          config:
            add:
              headers:
              - X-User-Id:$(jwt_claims.userId)
              - X-User-Email:$(jwt_claims.email)
        - name: cors
          config:
            origins:
            - "*"
            methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
            headers:
            - Accept
            - Authorization
            - Content-Type
            - X-User-Id
            - X-User-Email
            credentials: true
            max_age: 3600
        - name: rate-limiting
          config:
            minute: 100
            hour: 1000
            policy: local
        - name: request-size-limiting
          config:
            allowed_payload_size: 10

      - name: sharing-routes
        paths:
        - /api/sharing
        strip_path: false
        plugins:
        - name: jwt
          config:
            uri_param_names:
            - jwt
            header_names:
            - Authorization
            claims_to_verify:
            - exp
            key_claim_name: iss
            secret_is_base64: false
            anonymous: null
            run_on_preflight: true
        - name: request-transformer
          config:
            add:
              headers:
              - X-User-Id:$(jwt_claims.userId)
              - X-User-Email:$(jwt_claims.email)
        - name: cors
          config:
            origins:
            - "*"
            methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
            headers:
            - Accept
            - Authorization
            - Content-Type
            - X-User-Id
            - X-User-Email
            credentials: true
            max_age: 3600
        - name: rate-limiting
          config:
            minute: 100
            hour: 1000
            policy: local
        - name: request-size-limiting
          config:
            allowed_payload_size: 10

      - name: folders-routes
        paths:
        - /api/folders
        strip_path: false
        plugins:
        - name: jwt
          config:
            uri_param_names:
            - jwt
            header_names:
            - Authorization
            claims_to_verify:
            - exp
            key_claim_name: iss
            secret_is_base64: false
            anonymous: null
            run_on_preflight: true
        - name: request-transformer
          config:
            add:
              headers:
              - X-User-Id:$(jwt_claims.userId)
              - X-User-Email:$(jwt_claims.email)
        - name: cors
          config:
            origins:
            - "*"
            methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
            headers:
            - Accept
            - Authorization
            - Content-Type
            - X-User-Id
            - X-User-Email
            credentials: true
            max_age: 3600
        - name: rate-limiting
          config:
            minute: 100
            hour: 1000
            policy: local
        - name: request-size-limiting
          config:
            allowed_payload_size: 10

    # JWT Consumers
    consumers:
    - username: conote-backend
      custom_id: conote-backend
      jwt_secrets:
      - algorithm: HS256
        key: conote-issuer
        secret: your-secret-key-change-this-in-production-min-256-bits
