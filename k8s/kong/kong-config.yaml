---
# ConfigMap for Kong declarative configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: conote
data:
  kong.yml: |
    _format_version: "3.0"

    # Backend Service
    services:
    - name: conote-backend
      url: http://backend.conote.svc.cluster.local:8080
      retries: 3
      connect_timeout: 60000
      write_timeout: 60000
      read_timeout: 60000

      routes:
      # Public routes (no JWT required)
      - name: auth-routes
        paths:
        - /api/auth
        strip_path: false
        methods:
        - GET
        - POST
        - OPTIONS

      # Protected routes (JWT required)
      - name: documents-routes
        paths:
        - /api/documents
        strip_path: false
        methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        plugins:
        - name: jwt
          config:
            key_claim_name: kid
            secret_is_base64: false
            claims_to_verify:
            - exp
            header_names:
            - Authorization
            uri_param_names: []

      - name: sharing-routes
        paths:
        - /api/sharing
        strip_path: false
        methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        plugins:
        - name: jwt
          config:
            key_claim_name: kid
            secret_is_base64: false
            claims_to_verify:
            - exp
            header_names:
            - Authorization

      - name: folders-routes
        paths:
        - /api/folders
        strip_path: false
        methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        plugins:
        - name: jwt
          config:
            key_claim_name: kid
            secret_is_base64: false
            claims_to_verify:
            - exp
            header_names:
            - Authorization

      # Health check route (no JWT required)
      - name: health-route
        paths:
        - /actuator/health
        strip_path: false
        methods:
        - GET

    # Global plugins
    plugins:
    - name: cors
      config:
        origins:
        - "*"
        methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        exposed_headers:
        - X-Auth-Token
        credentials: true
        max_age: 3600

    - name: rate-limiting
      config:
        minute: 100
        hour: 1000
        policy: local

    - name: request-size-limiting
      config:
        allowed_payload_size: 10

    # JWT Consumers (representing backend service JWT issuer)
    consumers:
    - username: conote-backend-issuer
      keyauth_credentials:
      - key: conote-backend-key
      jwt_secrets:
      - key: conote-backend-jwt
        algorithm: HS256
        # This secret must match JWT_SECRET in backend-secret
        secret: your-secret-key-change-this-in-production-make-it-at-least-256-bits-long-for-security-purposes
